# devcontainer.nvim TODO & 改善点

このファイルは、v0.2.0 LSP統合完了後の今後の改善点と計画を記録します。

## 現在の状況 (v0.2.0完了)

✅ **完了済み**
- 基本的なdevcontainer操作 (v0.1.0)
- LSP統合機能 (v0.2.0)
  - Docker内LSPサーバーの自動検出
  - 非同期Docker操作
  - パス変換機能
  - 再接続機能

## 緊急修正が必要な問題

### 🔴 高優先度

1. **postCreateCommand サポートの欠如**
   - 現状: devcontainer.json の postCreateCommand が実行されない
   - 影響: LSPサーバーやツールがインストールされず、LSP機能が使用不可
   - 重要度: 極めて高い（基本機能の前提条件）
   - 修正案: コンテナ作成後に postCreateCommand を自動実行する機能追加

2. **LSP Info でのクライアント表示問題**
   - 現状: `:LspInfo` でdevcontainer内pylspクライアントが表示されない
   - 影響: デバッグ時の状態確認が困難（ただし機能は正常動作）
   - 優先度: 中（実用上の問題は少ない）
   - 修正案: lspconfig との統合改善

### ✅ 修正完了

3. **エラーログのクリーンアップ** ✅
   - 修正済み: すべてのDEBUGプリントをlog.debug()に変更

4. **Docker関数の重複修正** ✅
   - 修正済み: M.M.run_docker_command → M.run_docker_command

5. **起動時の不要なメッセージ表示** ✅
   - 修正済み: 初期化メッセージをdebugレベルに変更

6. **LSP自動アタッチ機能** ✅
   - 実装済み: autocommandによる新規バッファへの自動アタッチ

### 🟡 中優先度

7. **パフォーマンス最適化**
   - LSPサーバー検出の並列化
   - Docker操作のキャッシュ機能
   - 不要なDocker呼び出しの削減

8. **エラーハンドリング強化**
   - Docker未起動時の適切なエラーメッセージ
   - LSPサーバー起動失敗時の復旧機能
   - ネットワークタイムアウトの処理

## 次のマイルストーン計画

### v0.2.1 (バグ修正リリース) - 1週間
- [ ] 上記高優先度問題の修正
- [ ] テストスイートの改善
- [ ] ドキュメントの更新

### v0.3.0 (ターミナル統合) - 4-6週間

#### 新機能
- [ ] **改良されたターミナル統合**
  - [ ] コンテナ内ターミナルの改善
  - [ ] セッション管理機能
  - [ ] ターミナル履歴の永続化

- [ ] **ポートフォワーディング機能**
  - [ ] 自動ポート検出
  - [ ] 動的フォワーディング
  - [ ] ポート管理UI

- [ ] **Telescope統合**
  - [ ] devcontainerピッカー
  - [ ] コマンド履歴ピッカー
  - [ ] ポート管理ピッカー

- [ ] **外部プラグイン統合**
  - [ ] nvim-test統合（テストコマンドのコンテナ内実行）
  - [ ] nvim-dap統合（デバッガーのコンテナ内実行）
  - [ ] 一般的なコマンド実行プラグインとの統合

#### 技術的改善
- [ ] **設定システムの拡張**
  - [ ] ユーザー設定のバリデーション
  - [ ] 設定の動的変更
  - [ ] プロファイル機能

- [ ] **UI/UX の向上**
  - [ ] ステータスライン表示
  - [ ] 通知システム
  - [ ] プログレス表示の改善

### v0.4.0 (マルチコンテナ対応) - 6-8週間

- [ ] **Docker Compose サポート**
  - [ ] docker-compose.yml の解析
  - [ ] マルチコンテナ環境の管理
  - [ ] サービス間通信

- [ ] **高度なネットワーク機能**
  - [ ] カスタムネットワーク設定
  - [ ] サービスディスカバリー
  - [ ] 負荷分散

### v1.0.0 (安定版リリース) - 3-4ヶ月後

- [ ] **完全なVSCode互換性**
- [ ] **包括的なテストスイート**
- [ ] **完全なドキュメント**
- [ ] **パフォーマンス最適化**

## 外部プラグイン統合の詳細設計

### nvim-test統合
現在、`klen/nvim-test`や`vim-test/vim-test`などのテストプラグインはローカル環境でコマンドを実行しますが、devcontainer環境では以下の統合が必要：

**実装アプローチ:**
- テストプラグインのコマンド実行をフック/オーバーライド
- コンテナが起動している場合は自動的にコンテナ内で実行
- 例: `:TestNearest` → `docker exec container_id go test -run TestFunction`

**対象プラグイン:**
- `klen/nvim-test` 
- `vim-test/vim-test`
- `nvim-neotest/neotest`

### nvim-dap統合
デバッガーもコンテナ内で実行する必要があり、以下が必要：

**実装要件:**
- DAP アダプターの設定をコンテナ内実行用に自動変更
- デバッグポートのフォワーディング
- コンテナ内でのデバッガー起動

### 一般的なコマンド実行統合
他のプラグインでも同様のパターンで統合可能：

**設計パターン:**
```lua
-- プラグイン統合のためのAPI
devcontainer.integrate_command_plugin({
  plugin_name = "nvim-test",
  command_patterns = {"Test*"},
  wrapper_function = function(original_cmd)
    return devcontainer.wrap_command(original_cmd)
  end
})
```

この機能により、開発者はdevcontainer内で完全な開発体験を得られます。

## 技術的負債と改善案

### アーキテクチャ改善

1. **モジュール間の依存関係整理**
   - 現状: 循環依存が一部存在
   - 改善: 依存関係グラフの最適化

2. **エラーハンドリングの統一**
   - 現状: モジュールごとに異なるエラー処理
   - 改善: 共通エラーハンドリングライブラリ

3. **設定システムの改善**
   - 現状: 設定の検証が不十分
   - 改善: JSON Schema ベースの検証

### パフォーマンス改善

1. **Docker操作の最適化**
   - 不要なDocker呼び出しの削減
   - 結果のキャッシュ
   - 並列処理の活用

2. **LSP通信の最適化**
   - 接続プールの実装
   - リクエストのバッチ処理
   - 応答時間の改善

### 開発体験の改善

1. **デバッグツールの充実**
   - より詳細なログ出力
   - デバッグモードの実装
   - プロファイリング機能

2. **テスト環境の整備**
   - CI/CDパイプライン
   - 自動テスト
   - パフォーマンステスト

## ユーザーフィードバック対応

### よく報告される問題

1. **Docker for Mac でのパフォーマンス問題**
   - ファイルマウントの最適化
   - キャッシュ戦略の改善

2. **Windows 環境での問題**
   - パス区切り文字の処理
   - ファイル権限の問題

3. **大きなプロジェクトでの動作**
   - メモリ使用量の最適化
   - 起動時間の改善

## 開発プロセスの改善

### 品質管理
- [ ] 自動テストの充実
- [ ] コードレビューガイドラインの策定
- [ ] パフォーマンス回帰テスト

### ドキュメント
- [ ] API ドキュメントの自動生成
- [ ] チュートリアルの充実
- [ ] トラブルシューティングガイド

### コミュニティ
- [ ] コントリビューションガイドライン
- [ ] イシューテンプレート
- [ ] ディスカッションフォーラム

---

**最終更新**: 2024-06-14  
**次回レビュー予定**: v0.2.1リリース後

このTODOリストは、プロジェクトの進行に合わせて定期的に更新されます。